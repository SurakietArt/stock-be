{% include 'navbar.html' %}

<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        table { border-collapse: collapse; width: 100%; margin-top: 1rem; }
        th, td { padding: 8px 12px; border: 1px solid #ccc; text-align: left; }
        .nav-btn {
            display: inline-block;
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        form.search-form {
            margin-bottom: 20px;
        }
        input[type="text"] {
            padding: 8px;
            width: 300px;
            font-size: 16px;
        }
        button[type="submit"] {
            padding: 8px 16px;
            font-size: 16px;
        }
        #loading {
            display: none;
            margin-top: 10px;
            font-style: italic;
            color: #666;
        }
        .sort-btn {
            border: none;
            background: none;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0;
        }
        .sort-arrow {
            color: gray;
            font-size: 0.8em;
        }

        .sort-arrow.active {
            color: black;
            font-weight: bold;
        }
    </style>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
    const form = document.querySelector(".search-form");
    const tableBody = document.querySelector("tbody");
    const loading = document.getElementById("loading");
    const sortBtn = document.getElementById("sort-amount");
    const arrowUp = document.getElementById("arrow-up");
    const arrowDown = document.getElementById("arrow-down");

    let originalItems = [];
    let currentItems = [];
    let sortState = 'default'; // asc -> desc -> default

    function fetchItems(query = "") {
        loading.style.display = "block";

        fetch(`/api/v1/stock/items?name=${encodeURIComponent(query)}`, {
            headers: { "X-Requested-With": "XMLHttpRequest" }
        })
        .then(response => response.json())
        .then(data => {
            originalItems = [...data];
            currentItems = [...data];
            displayItems(currentItems);
            resetSortState();
            loading.style.display = "none";
        })
        .catch(() => {
            tableBody.innerHTML = '<tr><td colspan="3">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
            loading.style.display = "none";
        });
    }

    function displayItems(items) {
        tableBody.innerHTML = "";
        if (items.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="3">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</td></tr>';
        } else {
            items.forEach(item => {
                 if (item.alert_threshold == null) {
                     item.alert_threshold = 0
                 }
                tableBody.innerHTML += `
                    <tr>
                        <td>${item.name}</td>
                        <td>${item.amount}</td>
                        <td>${item.alert_threshold}</td>
                        <td>${item.sku}</td>
                        <td>
                        <button type="button"
                            onclick="openModal(
                                ${item.id},
                                '${item.name.replace(/'/g, "\\'")}',
                                ${item.amount},
                                '${item.sku.replace(/'/g, "\\'")}',
                                ${item.alert_threshold !== null ? item.alert_threshold : 'null'}
                            )">‚öô ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
                        </td>
                    </tr>
                `;
            });
        }
    }

    function resetSortState() {
        sortState = 'default';
        arrowUp.classList.remove("active");
        arrowDown.classList.remove("active");
    }

    form.addEventListener("submit", function (e) {
        e.preventDefault();
        const query = form.querySelector("input[name='name']").value;
        fetchItems(query);
    });

    sortBtn.addEventListener("click", function () {
        if (sortState === 'default') {
            // ASCENDING
            currentItems.sort((a, b) => a.amount - b.amount);
            sortState = 'asc';
            arrowUp.classList.add("active");
            arrowDown.classList.remove("active");
        } else if (sortState === 'asc') {
            // DESCENDING
            currentItems.sort((a, b) => b.amount - a.amount);
            sortState = 'desc';
            arrowUp.classList.remove("active");
            arrowDown.classList.add("active");
        } else {
            // DEFAULT
            currentItems = [...originalItems];
            sortState = 'default';
            arrowUp.classList.remove("active");
            arrowDown.classList.remove("active");
        }

        displayItems(currentItems);
    });

    fetchItems(); // ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    });

    function closeModal() {
      document.getElementById('modal').style.display = 'none';
    }

    function openModal(id, name, amount, sku, alertThreshold) {
      const modal = document.getElementById('modal');
      document.getElementById('modal-item-id').value = id;
      document.getElementById('modal-name').value = name;
      document.getElementById('modal-amount').value = amount;
      document.getElementById('modal-sku').value = sku;
      document.getElementById('modal-alert-threshold').value = alertThreshold || 0; // ‡∏ñ‡πâ‡∏≤ null ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô 0

      const form = document.getElementById('editForm');
      form.action = `/api/v1/stock/items/${id}`;

      modal.style.display = 'block';
    }

    document.addEventListener('DOMContentLoaded', function() {
      const modal = document.getElementById('modal');
      const modalContent = modal.querySelector('div');

      modal.addEventListener('click', function(event) {
        if (!modalContent.contains(event.target)) {
          closeModal();
        }
      });

});

    </script>
</head>
<body>
    <h1>üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h1>

    <a href="/items/scan" class="nav-btn">üîç ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î</a>

    <form method="get" action="/items" class="search-form">
        <input type="text" name="name" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤...">
        <button type="submit">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
        <div id="loading">üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
    </form>

    <table>
        <thead>
            <tr>
                <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                <th style="white-space: nowrap;">
                    <span style="display: inline-flex; align-items: center;">
                        ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
                        <button id="sort-amount" class="sort-btn" style="margin-left: 6px; padding: 0; border: none; background: none; cursor: pointer;">
                            <span class="sort-arrow" id="arrow-up">‚ñ≤</span>
                            <span class="sort-arrow" id="arrow-down">‚ñº</span>
                        </button>
                    </span>
                </th>
                <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</th>
                <th>SKU</th>
                <th>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</th>
            </tr>
        </thead>
        <tbody>
            {% for item in items %}
            <tr>
                <td>{{ item.name }}</td>
                <td>{{ item.amount }}</td>
                <td>{{ item.sku }}</td>
                <td>{{ item.alert_threshold }}</td>
                <td>
                  <button type="button"
                    onclick="openModal(
                        {{ item.id }},
                        '{{ item.name|escapejs }}',
                        {{ item.amount }},
                        '{{ item.sku|escapejs }}',
                        {{ item.alert_threshold|default_if_none:'null' }}
                    )">‚öô ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="3">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
<div id="modal" style="display: none; position: fixed; top: 0; left: 0;
    width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000;">
  <div style="background: white; width: 400px; margin: 100px auto; padding: 24px; border-radius: 12px; position: relative; box-shadow: 0 0 10px rgba(0,0,0,0.3); font-family: sans-serif;">
    <h3 id="modal-title" style="margin-bottom: 20px; font-size: 20px;">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>

    <form id="editForm" method="patch" action="/api/v1/stock/items/">
      <input type="hidden" name="item_id" id="modal-item-id">

      <div style="margin-bottom: 16px;">
        <label for="modal-name" style="display: block; margin-bottom: 6px;">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</label>
        <input type="text" name="name" id="modal-name" required
               style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px;">
      </div>

      <div style="margin-bottom: 16px;">
        <label for="modal-amount" style="display: block; margin-bottom: 6px;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</label>
        <input type="number" name="amount" id="modal-amount" required min="0"
               style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px;">
      </div>

      <div style="margin-bottom: 24px;">
        <label for="modal-alert-threshold" style="display: block; margin-bottom: 6px;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô:</label>
        <input type="number" name="alert_threshold" id="modal-alert-threshold" min="0"
               style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px;">
      </div>

      <div style="margin-bottom: 16px;">
        <label for="modal-sku" style="display: block; margin-bottom: 6px;">SKU:</label>
        <input type="text" name="sku" id="modal-sku" required
               style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px;">
      </div>

      <div style="display: flex; justify-content: flex-end; gap: 12px;">
        <button type="submit" style="background-color: #4CAF50; color: white; padding: 10px 18px; border: none; border-radius: 6px; font-size: 14px; cursor: pointer;">
          üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
        </button>
        <button type="button" onclick="closeModal()"
                style="background-color: #ff0000; color: #ffffff; padding: 10px 18px; border: none; border-radius: 6px; font-size: 14px; cursor: pointer;">
          ‚ùå ‡∏õ‡∏¥‡∏î
        </button>
      </div>
    </form>
  </div>
</div>

</body>
</html>